#!/usr/bin/env bash

# Pre-commit hook for CMPM 121 F1 Love2D project
# This hook runs Lua syntax checks before each commit.

echo "üîç Running Lua pre-commit checks..."

# 1. Locate Lua compiler: try luac, then luac5.4, then luac5.3
LUAC=$(command -v luac 2>/dev/null || command -v luac5.4 2>/dev/null || command -v luac5.3 2>/dev/null)

if [ -z "$LUAC" ]; then
  echo "‚ùå Lua compiler ('luac' / 'luac5.4') is not installed or not in PATH."
  echo "   Please install Lua before committing."
  exit 1
fi

# 2. Get all staged Lua files
lua_files=$(git diff --cached --name-only -- '*.lua')

if [ -z "$lua_files" ]; then
  echo "‚úÖ No Lua files staged. Skipping Lua checks."
  exit 0
fi

echo "üìù Checking Lua syntax..."
failed=0

# 3. Check syntax for each staged Lua file
for file in $lua_files; do
  if [ -f "$file" ]; then
    echo "  ‚Ä¢ $file"
    if ! "$LUAC" -p "$file"; then
      echo "‚ùå Syntax error in $file"
      failed=1
    fi
  fi
done

# 4. If any file failed, block the commit
if [ "$failed" -ne 0 ]; then
  echo ""
  echo "‚ùå Lua syntax check failed. Fix the errors above before committing."
  exit 1
fi

echo "‚úÖ All Lua pre-commit checks passed!"
exit 0
