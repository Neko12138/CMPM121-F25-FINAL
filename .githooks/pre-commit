#!/bin/sh
# Pre-commit hook for CMPM 121 F1 Love2D project
# Runs Lua syntax checking on tracked .lua files before each commit.

set -e

echo "üîç Running Lua pre-commit checks..."

# 1. Find Lua interpreter (lua or lua5.4)
LUA_CMD=$(command -v lua 2>/dev/null || command -v lua5.4 2>/dev/null)

if [ -z "$LUA_CMD" ]; then
  echo "‚ùå Lua interpreter not found (lua / lua5.4)."
  echo "   Please install Lua before committing."
  exit 1
fi

# 2. Collect all tracked Lua files (not only staged ones)
lua_files=$(git ls-files '*.lua')

if [ -z "$lua_files" ]; then
  echo "‚úÖ No Lua files in repository. Skipping Lua checks."
  exit 0
fi

echo "üìù Checking Lua syntax via: $LUA_CMD"
failed=0

# 3. Check syntax for each Lua file using loadfile (compile only, do not run)
for file in $lua_files; do
  if [ -f "$file" ]; then
    echo " ‚Ä¢ $file"
    if ! "$LUA_CMD" -e 'assert(loadfile(arg[1]))' "$file"; then
      echo "‚ùå Syntax error in $file"
      failed=1
    fi
  fi
done

# 4. If any file failed, block the commit
if [ "$failed" -ne 0 ]; then
  echo ""
  echo "‚ùå Lua syntax check failed. Fix the errors above before committing."
  exit 1
fi

echo "‚úÖ All Lua pre-commit checks passed!"
exit 0
