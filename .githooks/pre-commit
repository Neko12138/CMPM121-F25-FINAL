#!/usr/bin/env bash

# Pre-commit hook for CMPM121 F1 Love2D project
# Runs Lua syntax checking on staged Lua files

echo "üîç Running Lua pre-commit checks..."

# find lua interpreter
LUA_CMD=$(command -v lua 2>/dev/null || command -v lua5.4 2>/dev/null)

if [ -z "$LUA_CMD" ]; then
  echo "‚ùå Lua interpreter not found (lua / lua5.4)."
  exit 1
fi

# staged lua files
lua_files=$(git diff --cached --name-only -- '*.lua')

if [ -z "$lua_files" ]; then
  echo "‚úÖ No Lua files staged."
  exit 0
fi

echo "üìù Checking syntax via $LUA_CMD ..."
failed=0

for file in $lua_files; do
  if [ -f "$file" ]; then
    echo " ‚Ä¢ $file"
    if ! "$LUA_CMD" -e 'assert(loadfile(arg[1]))' "$file"; then
      echo "‚ùå Syntax error in $file"
      failed=1
    fi
  fi
done

if [ "$failed" -ne 0 ]; then
  echo "‚ùå Lua syntax check failed."
  exit 1
fi

echo "‚úÖ All Lua checks passed!"
exit 0
