#!/bin/sh
# Pre-commit hook for CMPM 121 Love2D project
# Checks Lua syntax for staged (.lua) files only.

set -e

# Debug: set PRE_COMMIT_DEBUG=1 to get more verbose output
DEBUG=${PRE_COMMIT_DEBUG:-0}

echo "üîç Running Lua pre-commit checks (staged files)..."

# Find Lua interpreter (lua or lua5.4)
LUA_CMD=$(command -v lua 2>/dev/null || command -v lua5.4 2>/dev/null || true)

if [ -z "$LUA_CMD" ]; then
  echo "‚ùå Lua interpreter not found (lua / lua5.4)."
  echo "   Please install Lua before committing."
  exit 1
fi

# Get staged files that will be committed and end with .lua
# diff-filter=ACM -> Added, Copied, Modified
staged=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.lua$' || true)

if [ -z "$staged" ]; then
  [ "$DEBUG" -eq 1 ] && echo "‚úÖ No staged Lua files to check."
  exit 0
fi

echo "üìù Checking staged Lua files via: $LUA_CMD"
failed=0

# Create a temporary directory to extract staged versions (so we validate exactly what's being committed)
tmpdir=$(mktemp -d 2>/dev/null || echo "/tmp/precommit-$$")

for file in $staged; do
  echo " ‚Ä¢ $file"
  # Ensure parent dir exists in temp
  mkdir -p "$tmpdir/$(dirname "$file")"
  # Extract staged content into temp file
  if ! git show ":$file" > "$tmpdir/$file" 2>/dev/null; then
    echo "‚ùå Failed to read staged content for $file (it may be renamed/deleted)."
    failed=1
    continue
  fi

  # Run Lua syntax check on the staged copy
  if ! "$LUA_CMD" -e 'assert(loadfile(arg[1]))' "$tmpdir/$file"; then
    echo "‚ùå Syntax error in $file"
    failed=1
  else
    [ "$DEBUG" -eq 1 ] && echo "‚úî OK: $file"
  fi
done

# Clean up
rm -rf "$tmpdir"

if [ "$failed" -ne 0 ]; then
  echo ""
  echo "‚ùå Lua syntax check failed. Fix the errors above before committing."
  exit 1
fi

echo "‚úÖ All staged Lua syntax checks passed!"
exit 0
